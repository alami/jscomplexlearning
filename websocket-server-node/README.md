546758 - Простой WebSocket-сервер на Node.JS
   https://github.com/bkwebeagle/websocket-server-nodejs

    mkdir websocket-server-node ;  cd websocket-server-node
    npm init         ----несколько вопросов, их можно пропустить
    npm install ws   ----установить библиотеку WS
    npm install --save-optional utf-8-validate   ---настройку для работы с текстом в UTF-8
  --------server.js------------------
    const WebSocket = require('ws');  --подкл библ ws для работы с WS
    const wsServer = new WebSocket.Server({port: 9000});
    ^ -- константу-экземпляр класса WebSocket, с указанием порта на котором будет запущен
В отличии от HTTP-сервера,
    WebSocket-сервер принимает подключение и удерживает его. 
HTTP-сервер принимает запросы напрямую, а
    WebSocket-сервер принимает запросы от подключения, т.е.соединение - полнодуплексное
  wsServer.on('connection', onConnect);
на событие ----^--(подключение) вешаем обработчик функцию "onConnect"
               ^--в onConnection передаётся объекта ws-соединения,
В момент подключения нового клиента через него сервер будет общаться с каждым конкретным клиентом.
^-- onConnect принимает только один параметр назовём его wsClient.

Мы подключим только 2 обработчика событий на объект wsClient:
	1) message - обрабатывает событие входящего сообщения от клиента.
	2) close - событие разрыва соединения с клиентом.
^--В самом начале функции onConnect,
выведем в консоль сообщение что новый пользователь в сети. 
И отправим клиенту приветственное сообщение

пишем обработчик сообщений со стороны клиента:
   команды сервер будет принимать в JSON-формате
   отдельно указывая команду и параметры, 
   а ответ сервера будет возвращаться в текстовом формате.
Формат JSON команд от клиента:
{
  action: 'ECHO' | 'PING',
  data?: string // необязательный параметр
}
т.е. 2 команды:
   echo-запрос, в ответ на который сервер отправит содержимое data
   ping,            в ответ сервер отправит pong
   если команда не известна, сервер выведет в консоль уведомление "Неизвестная команда"

  node server.js   ///run server
------------------- server2.js------------------
const ws = require('ws');
const wsServer = new ws.Server({port: 9000});
console.log('Сервер запущен на 9000 порту');

wsServer.on('connection', (wsc) => {
    console.log('User подключился');
    wsc.send('Вы подключились');    // отправка приветственного сообщения клиенту
    //--исп.только 2 обработчика событий на объект ws-соединения: 1)разрыв соединения
    wsc.on('close', () => {console.log('User отключился')})//      - отключение клиента
    wsc.on('message', (msg) =>{                     //2)обработчик сообщений от клиента
      console.log(msg);
      try {
        const jsonMessage = JSON.parse(msg);//т.к.сообщение-текст,сначала конверт в JSON
        switch (jsonMessage.action) {
            case 'ECHO':wsc.send("Сервер услышал: " + jsonMessage.data);break;
            case 'PING':setTimeout(()=>{wsc.send('PONG')}, 2000);break;
            default:    console.log('Неизвестная команда');break;
        }
      } catch (error) {console.log('Ошибка', error);}
    })
})
-------------------- client 2 ------------------
let myWs = new WebSocket('ws://localhost:9000')
myWs.onmessage = function (msg) {console.log('Msg:' + msg.data);};

myWs.send(JSON.stringify({action: 'PING'}));
myWs.send(JSON.stringify({action: 'ECHO', data: 'Сервер, ответь мне!'}));
myWs.close()
========================================================================
516334 - Как использовать Websocket на примере простого Express API?

Websocket — это протокол связи поверх TCP-соединения,
 предназначенный для обмена сообщениями между браузером и веб-сервером в режиме реального времени.
 Для установления соединения WebSocket клиент и сервер используют протокол,
            похожий на HTTP ! поле «Content-Length» отсутствует в заголовках, ...
 Клиент формирует особый HTTP-запрос, на который сервер отвечает определенным образом.
(+)простота: На клиенте и сервере есть всего 4 события для обработки:
    connection
    error
    message
    close
еще 2 способа непрерывной передачи данных:
Server-Sent Events (SSE) и Long Polling:
1)запрос на изменения;
2)Если изменения на сервере появились, то сервер их отправляет;
3)Когда клиент получает изменения, клиент делает новый запрос.
------------Websocket---------------SSE---------Long Polling---
протокол: 	websocket (ws, или wss) HTTP(S) 	HTTP(S)
скорость: 	высокая 	            низкая 	    низкая
направленность
потоков данных:2-направленная 	1-направленная 	2-направленная
дополнительно:
  передача бинарных данных,     автоматическое
  отсутствует поддержка         переподключение
  некоторых старых браузеров 	при обрыве соединения
-----------------------------------------------------------------
(+) не требует от клиента постоянно запрашивать изменения и именно поэтому он быстрее.
(+) позволяет передавать бинарные данные, что не позволяет протокол HTTP(S).
(-) требует совместимость со старыми версиями браузеров
------------------ server3.js---------------------------
const http = require("http");
const express = require( "express");
const ws = require( "ws");

const app = express();
const server = http.createServer(app);  //---создаем обычный http сервер,
                       // а потом привязываем к нему при создании websocket сервер.
const wsServer = new ws.Server({ port: 9000});//server });
console.log('Сервер запущен на 9000 порту');

wsServer.on('connection', wsc => {
    wsc.on('message', msg => {
        wsServer.clients.forEach(client => client.send(msg));
    });
    wsc.on("error", e => wsc.send(e));
    wsc.send('Hi there, I am a WebSocket server');
});
функция получает параметр msg — сообщение, то есть то, что отправил пользователь.
т.е.можем отправить с клиента строку и обработать ее на сервере.
В данном случае сервер просто пересылает это сообщение всем, кто подключен к серверу websocket.
Массив clients объекта webSocketServer содержит все подключения к серверу.
Объект wsc в то же время хранит данные только об одном подключении.


Для полноценного API на основе вебсокетов, необходимо научить систему отличать один запрос от другого:

1) С клиента мы будем передавать запросы в виде строки-json:

const sendMessage = (message) => conn.send(JSON.stringify(
  { event: "chat-message", payload: { userName, message }}));

2) На сервере мы распарсим строку и выделем в ней поле event — тип запроса.
  Пропишем для каждого типа соответствующий ответ:

const dispatchEvent = (message, ws) => {
   const json = JSON.parse(message);
   switch (json.event) {
       case "chat-message":
          webSocketServer.clients.forEach(client => client.send(message));break;
       default: ws.send((new Error("Wrong query")).message);
   }
}


--В частности, например, тот факт, что вебсокеты через прокси нормально поднимаются далеко не во всех случаях и приходиться делать fallback на тот же long polling.

  Для организации api поверх ws попробуйте protobuf (protobufjs).
  В таком случае будет сразу и более компактный бинарный формат
   и автоматически генерируемый код описания сообщений.
    А благодаря oneof можно и не вводить дополнительное поле-дискриминатор.

